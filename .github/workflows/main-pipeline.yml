# .github/workflows/main-pipeline.yml
name: Main CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test stage'
        required: false
        default: false
        type: boolean
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  # Stage 1: Build
  build:
    uses: ./.github/workflows/build.yml
    secrets: inherit

  # Stage 2: Test (runs in parallel with build for faster feedback)
  test:
    if: ${{ !inputs.skip_tests }}
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # Stage 3: Deploy (only after build and test succeed)
  deploy:
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    needs: [build, test]
    uses: ./.github/workflows/deploy.yml
    secrets: inherit
    with:
      environment: ${{ inputs.deploy_environment || 'staging' }}

  # Notification job
  notify:
    runs-on: ubuntu-latest
    needs: [build, test, deploy]
    if: always()
    
    steps:
    - name: Determine pipeline status
      id: status
      run: |
        if [[ "${{ needs.build.result }}" == "success" && "${{ needs.test.result }}" == "success" && ("${{ needs.deploy.result }}" == "success" || "${{ needs.deploy.result }}" == "skipped") ]]; then
          echo "status=✅ SUCCESS" >> $GITHUB_OUTPUT
        else
          echo "status=❌ FAILED" >> $GITHUB_OUTPUT
        fi

    - name: Pipeline Summary
      run: |
        echo "## 🚀 Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result == 'success' && '✅' || '❌' }} ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test | ${{ needs.test.result == 'success' && '✅' || needs.test.result == 'skipped' && '⏭️' || '❌' }} ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy | ${{ needs.deploy.result == 'success' && '✅' || needs.deploy.result == 'skipped' && '⏭️' || '❌' }} ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Overall Status:** ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY